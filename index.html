<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thai Lottery Form</title>
  <link href="https://fonts.googleapis.com/css2?family=TH+Sarabun+New&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
  <style>
    body {
      font-family: 'TH Sarabun New', sans-serif;
      margin: 0;
      padding: 1rem;
      background-color: #f8f8f8;
    }
    .container {
      max-width: 720px;
      margin: 0 auto;
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    h2 {
      margin-top: 0;
      font-size: 1.5rem;
    }
    label {
      font-size: 1rem;
      display: block;
      margin: 0.5rem 0 0.25rem;
    }
    input, select, button {
      font-size: 1rem;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      margin-top: 0.5rem;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .row input, .row select {
      flex: 1;
    }
    .table-container {
      margin-top: 1rem;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 0.25rem;
      font-size: 1rem;
    }
    .footer-controls {
      text-align: center;
      margin-top: 2rem;
    }
    #qr-reader {
      display: none;
      width: 100%;
      max-width: 360px;
      height: 360px;
      margin-top: 10px;
    }
    @media (max-width: 480px) {
      h2 { font-size: 1.25rem; }
      label, input, select, button { font-size: 1rem; }
    }
  </style>
</head>
<body>
<div class="container">
  <h2>ฟอร์มกรอกสลากกินแบ่ง</h2>
  <label for="ownerName">ชื่อเจ้าของ:</label>
  <input type="text" id="ownerName" placeholder="เช่น รัชนนท์ พงษ์สิทธิถาวร" />

  <button onclick="startQRScanner()">เริ่มสแกน QR</button>

  <div id="qr-reader"></div>

  <label style="margin-top:1rem;">หรือกรอกข้อมูลด้วยตนเอง:</label>
  <div class="row">
    <input type="text" id="manualSet" placeholder="ชุดที่ (2 หลัก)" maxlength="2" />
    <input type="text" id="manualNumber" placeholder="เลขสลาก (6 หลัก)" maxlength="6" />
    <button onclick="manualInputQR()">เพิ่ม</button>
  </div>

  <div class="table-container" id="tablesContainer"></div>

  <div class="footer-controls">
    <button onclick="window.print()">พิมพ์</button>
  </div>
</div>
<script>
const prizeOptions = [
  "ข้างเคียงรางวัลที่ 1", "รางวัลที่ 2", "รางวัลที่ 3", "รางวัลที่ 4",
  "รางวัลที่ 5", "หน้า 3 ตัว", "ท้าย 3 ตัว", "ท้าย 2 ตัว",
  "หน้า 3 ตัว+ท้าย 3 ตัว", "หน้า 3 ตัว+ท้าย 2 ตัว", "ท้าย 3 ตัว+ท้าย 2 ตัว"
];
const lotteryOptions = ["รัฐบาล", "การกุศล"];

let currentTableIndex = 0;
let tableRowsFilled = [0, 0, 0, 0];
let html5QrCodeInstance = null;
let ticketSet = new Set();

function setActiveTable(index) {
  currentTableIndex = parseInt(index);
  document.querySelectorAll('.table-wrapper').forEach((el, i) => {
    el.classList.toggle('active-table', i === currentTableIndex);
  });
}

function fillTableFromParts(cc, dddddd) {
  const ticketCode = `${cc}-${dddddd}`;
  if (ticketSet.has(ticketCode)) {
    alert(`หมายเลขนี้ถูกกรอกไปแล้ว: ${ticketCode}`);
    return;
  }

  const row = tableRowsFilled[currentTableIndex];
  if (row >= 20) {
    alert("ตารางนี้ครบแล้ว");
    return;
  }

  const cells = [];
  for (let i = 0; i < 2; i++) {
    const cell = document.querySelector(`[data-cell="${currentTableIndex}-${row}-${i}"]`);
    cell.textContent = cc[i] || '';
    cells.push(cell);
  }
  for (let i = 0; i < 6; i++) {
    const cell = document.querySelector(`[data-cell="${currentTableIndex}-${row}-${i+2}"]`);
    cell.textContent = dddddd[i] || '';
    cells.push(cell);
  }

  // Add delete button
  const rowEl = cells[0].parentElement;
  const deleteBtn = document.createElement('button');
  deleteBtn.textContent = "❌";
  deleteBtn.className = "delete-btn";
  deleteBtn.onclick = () => {
    cells.forEach(cell => cell.textContent = '');
    rowEl.removeChild(deleteBtn);
    ticketSet.delete(ticketCode);
    tableRowsFilled[currentTableIndex]--;
    updateFooter(currentTableIndex);
  };
  rowEl.appendChild(deleteBtn);

  ticketSet.add(ticketCode);
  tableRowsFilled[currentTableIndex]++;
  updateFooter(currentTableIndex);
}

function manualInputQR() {
  const cc = document.getElementById("manualSet").value.trim();
  const dddddd = document.getElementById("manualNumber").value.trim();

  if (!/^\d{2}$/.test(cc)) {
    alert("กรุณากรอกชุดที่ให้ถูกต้อง (2 หลัก)");
    return;
  }

  if (!/^\d{6}$/.test(dddddd)) {
    alert("กรุณากรอกเลขสลากให้ถูกต้อง (6 หลัก)");
    return;
  }

  fillTableFromParts(cc, dddddd);
  document.getElementById("manualSet").value = "";
  document.getElementById("manualNumber").value = "";
  document.getElementById("manualSet").focus();
}

function startQRScanner() {
  const qrDiv = document.getElementById("qr-reader");
  qrDiv.innerHTML = "";
  qrDiv.style.display = "block";
  qrDiv.style.height = "360px";

  if (html5QrCodeInstance) {
    html5QrCodeInstance.stop().catch(() => {});
    html5QrCodeInstance.clear().catch(() => {});
  }

  html5QrCodeInstance = new Html5Qrcode("qr-reader");
  const config = { fps: 10, qrbox: { width: 250, height: 250 } };

  html5QrCodeInstance.start(
    { facingMode: "environment" },
    config,
    qrMessage => {
      if (!qrMessage.includes('-')) return;
      const parts = qrMessage.split('-');
      if (parts.length !== 5) {
        alert("QR format invalid");
        return;
      }
      fillTableFromParts(parts[2], parts[3]);
      html5QrCodeInstance.stop().then(() => {
        qrDiv.style.display = "none";
      }).catch(err => {
        console.error("Failed to stop camera", err);
      });
    },
    err => {
      // Optional: console.log("Scan error:", err);
    }
  ).catch(err => {
    alert("ไม่สามารถเปิดกล้องได้: " + err);
  });
}

function createTables() {
  const container = document.getElementById('tablesContainer');
  for (let t = 0; t < 4; t++) {
    const wrapper = document.createElement('div');
    wrapper.className = 'table-wrapper';

    const prizeSelect = document.createElement('select');
    prizeSelect.id = `prize-${t}`;
    prizeSelect.classList.add('no-print');
    prizeOptions.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt; o.textContent = opt;
      prizeSelect.appendChild(o);
    });

    const lotterySelect = document.createElement('select');
    lotterySelect.id = `lottery-${t}`;
    lotterySelect.classList.add('no-print');
    lotteryOptions.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt; o.textContent = opt;
      lotterySelect.appendChild(o);
    });

    const grid = document.createElement('div');
    grid.className = 'lottery-grid';
    for (let col = 0; col < 2; col++) {
      const column = document.createElement('div');
      column.className = 'lottery-column';
      for (let row = 0; row < 10; row++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'lottery-row';
        const index = col * 10 + row;
        const rowNum = document.createElement('div');
        rowNum.className = 'row-number';
        rowNum.textContent = index + 1;
        rowDiv.appendChild(rowNum);
        for (let c = 0; c < 8; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          if (c === 1) cell.classList.add('gap-after-2');
          cell.setAttribute('data-cell', `${t}-${index}-${c}`);
          rowDiv.appendChild(cell);
        }
        column.appendChild(rowDiv);
      }
      grid.appendChild(column);
    }

    const footer = document.createElement('div');
    footer.className = 'footer';
    footer.innerHTML = `
      <span class="footer-align-left" id="lottery-type-${t}"></span>
      <span class="footer-align-prize" id="prize-type-${t}"></span>
      <span class="footer-right">รวม <span id="total-${t}">0</span> ชุด</span>
    `;

    const footerCenter = document.createElement('div');
    footerCenter.className = 'footer-center';
    footerCenter.innerHTML = `ชื่อ <span id="owner-${t}"></span>`;

    prizeSelect.onchange = () => updateFooter(t);
    lotterySelect.onchange = () => updateFooter(t);

    wrapper.appendChild(grid);
    wrapper.appendChild(prizeSelect);
    wrapper.appendChild(lotterySelect);
    wrapper.appendChild(footer);
    wrapper.appendChild(footerCenter);
    container.appendChild(wrapper);
  }
}

function updateFooter(index) {
  const name = document.getElementById('ownerName').value;
  document.getElementById(`owner-${index}`).textContent = name;
  document.getElementById(`prize-type-${index}`).textContent = document.getElementById(`prize-${index}`).value;
  document.getElementById(`lottery-type-${index}`).textContent = document.getElementById(`lottery-${index}`).value;
  document.getElementById(`total-${index}`).textContent = tableRowsFilled[index];
}

document.addEventListener('DOMContentLoaded', () => {
  createTables();
  document.getElementById('ownerName').addEventListener('input', () => {
    for (let i = 0; i < 4; i++) updateFooter(i);
  });

  // Enable Enter key for manual input
  document.getElementById("manualNumber").addEventListener("keydown", e => {
    if (e.key === "Enter") {
      manualInputQR();
    }
  });
  document.getElementById("manualSet").addEventListener("keydown", e => {
    if (e.key === "Enter") {
      document.getElementById("manualNumber").focus();
    }
  });
});
</script>
</body>
</html>
